<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header class="flex" style="margin-bottom: 30px;">
            <h2>üõ†Ô∏è –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</h2>
            <div class="flex" style="width:auto; justify-content:flex-end;">
                <button class="secondary" style="width:auto;" onclick="window.location.href='/dashboard.html'">‚Üê –ù–∞–∑–∞–¥</button>
                <button class="secondary" style="width:auto;" onclick="logout()">–í—ã–π—Ç–∏</button>
            </div>
        </header>

        <div class="card" style="padding: 0; overflow: hidden;">
            <div class="flex" style="gap: 0;">
                <button id="tab-dashboard" class="secondary" style="border-radius: 0; width: 25%;" onclick="showTab('dashboard')">Dashboard</button>
                <button id="tab-users" class="secondary" style="border-radius: 0; width: 25%;" onclick="showTab('users')">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
                <button id="tab-trips" class="secondary" style="border-radius: 0; width: 25%;" onclick="showTab('trips')">–ü–æ–µ–∑–¥–∫–∏</button>
                <button id="tab-motd" class="secondary" style="border-radius: 0; width: 25%;" onclick="showTab('motd')">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
            </div>
        </div>

        <div id="tab-content-dashboard" class="tab-content">
            <div class="card">
                <h3>üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <div id="stats"></div>
            </div>
        </div>

        <div id="tab-content-users" class="tab-content" style="display:none;">
            <div class="card">
                <h3>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h3>
                <div id="users-list"></div>
            </div>
        </div>

        <div id="tab-content-trips" class="tab-content" style="display:none;">
            <div class="card">
                <h3>üßæ –ú–æ–¥–µ—Ä–∞—Ü–∏—è –ø–æ–µ–∑–¥–æ–∫</h3>
                <div class="flex" style="align-items:center; flex-wrap: wrap;">
                    <div style="flex:1; min-width: 220px;">
                        <input style="margin-bottom: 0;" type="number" id="cleanup-days" placeholder="–£–¥–∞–ª–∏—Ç—å –ø–æ–µ–∑–¥–∫–∏ —Å—Ç–∞—Ä—à–µ –¥–Ω–µ–π (–Ω–∞–ø—Ä. 30)">
                    </div>
                    <div style="flex:1; min-width: 220px;">
                        <input style="margin-bottom: 0;" type="text" id="cleanup-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç (–Ω–∞–ø—Ä. test/—Ç–µ—Å—Ç)">
                    </div>
                    <button style="width:auto;" onclick="cleanupTrips()">–û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>
                <div id="trips-list"></div>
            </div>
        </div>

        <div id="tab-content-motd" class="tab-content" style="display:none;">
            <div class="card">
                <h3>üì£ –°–æ–æ–±—â–µ–Ω–∏–µ –¥–Ω—è</h3>
                <textarea id="motd-text" style="width:100%; min-height: 120px; padding: 12px 16px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1rem; background: #f9fafb; box-sizing: border-box;"></textarea>
                <div class="flex" style="justify-content:flex-end; margin-top: 12px;">
                    <button class="danger" style="width:auto;" onclick="deleteMotd()">–£–¥–∞–ª–∏—Ç—å</button>
                    <button style="width:auto;" onclick="saveMotd()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        async function ensureAdmin() {
            const res = await fetchAPI('/me');
            if (!res.ok) {
                window.location.href = '/index.html';
                return null;
            }
            const me = await res.json();
            if (!me.is_admin) {
                alert('–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞');
                window.location.href = '/dashboard.html';
                return null;
            }
            return me;
        }

        function showTab(tab) {
            const map = {
                dashboard: 'tab-content-dashboard',
                users: 'tab-content-users',
                trips: 'tab-content-trips',
                motd: 'tab-content-motd'
            };
            Object.values(map).forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
            document.getElementById(map[tab]).style.display = 'block';

            if (tab === 'dashboard') loadStats();
            if (tab === 'users') loadUsers();
            if (tab === 'trips') loadTrips();
            if (tab === 'motd') loadMotd();
        }

        async function loadStats() {
            const res = await fetchAPI('/admin/stats');
            if (!res.ok) return;
            const s = await res.json();
            document.getElementById('stats').innerHTML = `
                <div class="flex" style="flex-wrap: wrap; align-items: flex-start;">
                    <div class="card" style="margin:0; flex:1; min-width: 220px; box-shadow:none; border:1px solid #eee;">
                        <div style="color: var(--text-secondary);">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                        <div style="font-size: 1.8rem; font-weight: 700;">${s.total_users}</div>
                    </div>
                    <div class="card" style="margin:0; flex:1; min-width: 220px; box-shadow:none; border:1px solid #eee;">
                        <div style="color: var(--text-secondary);">–í—Å–µ–≥–æ –ø–æ–µ–∑–¥–æ–∫</div>
                        <div style="font-size: 1.8rem; font-weight: 700;">${s.total_trips}</div>
                    </div>
                    <div class="card" style="margin:0; flex:1; min-width: 220px; box-shadow:none; border:1px solid #eee;">
                        <div style="color: var(--text-secondary);">–í—Å–µ–≥–æ —Ç–æ—á–µ–∫</div>
                        <div style="font-size: 1.8rem; font-weight: 700;">${s.total_items}</div>
                    </div>
                    <div class="card" style="margin:0; flex:1; min-width: 220px; box-shadow:none; border:1px solid #eee;">
                        <div style="color: var(--text-secondary);">–°—É–º–º–∞ –±—é–¥–∂–µ—Ç–æ–≤</div>
                        <div style="font-size: 1.8rem; font-weight: 700;">${s.sum_budgets} ‚ÇΩ</div>
                    </div>
                    <div class="card" style="margin:0; flex:1; min-width: 220px; box-shadow:none; border:1px solid #eee;">
                        <div style="color: var(--text-secondary);">–ü–æ–µ–∑–¥–æ–∫ –∑–∞ 7 –¥–Ω–µ–π</div>
                        <div style="font-size: 1.8rem; font-weight: 700;">${s.trips_last_7_days}</div>
                    </div>
                </div>
            `;
        }

        async function loadUsers() {
            const res = await fetchAPI('/admin/users');
            if (!res.ok) {
                let msg = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π';
                try {
                    const err = await res.json();
                    if (err && err.error) msg = err.error;
                } catch(e) {}
                alert(msg);
                return;
            }
            const users = await res.json();
            const container = document.getElementById('users-list');

            if (!users.length) {
                container.innerHTML = '<p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ—Ç.</p>';
                return;
            }

            container.innerHTML = users.map(u => `
                <div class="flex" style="align-items:flex-start; justify-content:space-between; padding: 12px 0; border-bottom: 1px solid #eee; gap: 12px;">
                    <div style="flex:1; min-width: 0;">
                        <div style="font-weight: 600;">${u.name} ${u.is_admin ? '<span class="badge" style="margin-left:8px;">ADMIN</span>' : ''} ${u.is_banned ? '<span class="badge" style="margin-left:8px; background:#fee2e2; color:#b91c1c;">BANNED</span>' : ''}</div>
                        <div style="color: var(--text-secondary);">${u.email}</div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem;">ID: ${u.id} ‚Ä¢ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: ${u.created_at || '-'}</div>
                    </div>
                    <div class="flex" style="width:auto; justify-content:flex-end; gap: 10px;">
                        <button class="secondary" style="width:auto;" onclick="toggleBan(${u.id}, ${u.is_banned ? 'false' : 'true'})">
                            ${u.is_banned ? '–†–∞–∑–±–∞–Ω–∏—Ç—å' : '–ó–∞–±–∞–Ω–∏—Ç—å'}
                        </button>
                        <button class="secondary" style="width:auto;" onclick="toggleAdmin(${u.id}, ${u.is_admin ? 'false' : 'true'})">
                            ${u.is_admin ? '–°–Ω—è—Ç—å –∞–¥–º–∏–Ω–∞' : '–°–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–æ–º'}
                        </button>
                        <button class="danger" style="width:auto;" onclick="deleteUser(${u.id})">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>
            `).join('');
        }

        async function toggleAdmin(userId, makeAdmin) {
            const ok = confirm(makeAdmin ? '–ù–∞–∑–Ω–∞—á–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º?' : '–°–Ω—è—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞?');
            if (!ok) return;
            const res = await fetchAPI(`/admin/users/${userId}`, 'PATCH', { is_admin: !!makeAdmin });
            if (!res.ok) {
                let msg = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å';
                try {
                    const err = await res.json();
                    if (err && err.error) msg = err.error;
                } catch(e) {}
                alert(msg);
                return;
            }
            loadUsers();
        }

        async function toggleBan(userId, ban) {
            const ok = confirm(ban ? '–ó–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∑–∞–ø—Ä–µ—Ç–∏—Ç—å –≤—Ö–æ–¥)?' : '–†–∞–∑–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?');
            if (!ok) return;
            const res = await fetchAPI(`/admin/users/${userId}`, 'PATCH', { is_banned: !!ban });
            if (!res.ok) {
                let msg = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å';
                try {
                    const err = await res.json();
                    if (err && err.error) msg = err.error;
                } catch(e) {}
                alert(msg);
                return;
            }
            loadUsers();
        }

        async function deleteUser(userId) {
            const ok = confirm('–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?');
            if (!ok) return;
            const res = await fetchAPI(`/admin/users/${userId}`, 'DELETE');
            if (!res.ok) {
                let msg = '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å';
                try {
                    const err = await res.json();
                    if (err && err.error) msg = err.error;
                } catch(e) {}
                alert(msg);
                return;
            }
            loadUsers();
        }

        async function loadTrips() {
            const res = await fetchAPI('/admin/trips');
            if (!res.ok) {
                let msg = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–µ–∑–¥–∫–∏';
                try {
                    const err = await res.json();
                    if (err && err.error) msg = err.error;
                } catch(e) {}
                document.getElementById('trips-list').innerHTML = `<p>${msg}</p>`;
                return;
            }
            const trips = await res.json();
            const container = document.getElementById('trips-list');
            if (!trips.length) {
                container.innerHTML = '<p>–ü–æ–µ–∑–¥–æ–∫ –Ω–µ—Ç.</p>';
                return;
            }
            container.innerHTML = trips.map(t => `
                <div class="flex" style="align-items:flex-start; justify-content:space-between; padding: 12px 0; border-bottom: 1px solid #eee; gap: 12px;">
                    <div style="flex:1; min-width:0;">
                        <div style="font-weight: 600;">${t.title}</div>
                        <div style="color: var(--text-secondary);">${t.start_date || '-'} ‚Äî ${t.end_date || '-'}</div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem;">Trip ID: ${t.id} ‚Ä¢ User: ${t.user_email} ‚Ä¢ Created: ${t.created_at || '-'}</div>
                    </div>
                    <div style="text-align:right; min-width: 160px;">
                        <div style="font-weight:700;">${t.budget || 0} ‚ÇΩ</div>
                        <button class="danger" style="width:auto; margin-top: 8px;" onclick="deleteTrip(${t.id})">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>
            `).join('');
        }

        async function deleteTrip(tripId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø–æ–µ–∑–¥–∫—É?')) return;
            const res = await fetchAPI(`/admin/trips/${tripId}`, 'DELETE');
            if (!res.ok) {
                let msg = '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å';
                try {
                    const err = await res.json();
                    if (err && err.error) msg = err.error;
                } catch(e) {}
                alert(msg);
                return;
            }
            loadTrips();
        }

        async function cleanupTrips() {
            const older = document.getElementById('cleanup-days').value;
            const title = document.getElementById('cleanup-title').value;
            const res = await fetchAPI('/admin/trips/cleanup', 'POST', {
                older_than_days: older ? Number(older) : 0,
                title_contains: title || ''
            });
            if (!res.ok) {
                let msg = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å';
                try {
                    const err = await res.json();
                    if (err && err.error) msg = err.error;
                } catch(e) {}
                alert(msg);
                return;
            }
            const data = await res.json();
            alert(`–£–¥–∞–ª–µ–Ω–æ –ø–æ–µ–∑–¥–æ–∫: ${data.deleted}`);
            loadTrips();
        }

        async function loadMotd() {
            const res = await fetchAPI('/motd');
            if (!res.ok) {
                document.getElementById('motd-text').value = '';
                return;
            }
            const data = await res.json();
            document.getElementById('motd-text').value = (data && data.message) ? data.message : '';
        }

        async function saveMotd() {
            const message = document.getElementById('motd-text').value;
            const res = await fetchAPI('/admin/motd', 'PUT', { message });
            if (!res.ok) {
                let msg = '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                try {
                    const err = await res.json();
                    if (err && err.error) msg = err.error;
                } catch(e) {}
                alert(msg);
                return;
            }
            alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
        }

        async function deleteMotd() {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–Ω—è?')) return;
            const res = await fetchAPI('/admin/motd', 'DELETE');
            if (!res.ok) {
                let msg = '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å';
                try {
                    const err = await res.json();
                    if (err && err.error) msg = err.error;
                } catch(e) {}
                alert(msg);
                return;
            }
            document.getElementById('motd-text').value = '';
            alert('–£–¥–∞–ª–µ–Ω–æ');
        }

        (async () => {
            const me = await ensureAdmin();
            if (!me) return;
            showTab('dashboard');
        })();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ú–æ–∏ –ø–æ–µ–∑–¥–∫–∏</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header class="flex" style="margin-bottom: 30px;">
            <h2>üó∫Ô∏è –ú–æ–∏ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è</h2>
            <div class="flex" style="width:auto; justify-content:flex-end;">
                <span id="admin-btn"></span>
                <button class="secondary" style="width: auto;" onclick="logout()">–í—ã–π—Ç–∏</button>
            </div>
        </header>

        <div id="motd" class="card" style="display:none; border-left: 5px solid var(--primary);"></div>

        <div class="card">
            <h3>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –ø–æ–µ–∑–¥–∫—É</h3>
            <div class="flex" style="align-items: flex-start; flex-wrap: wrap;">
                <div style="flex: 2; min-width: 200px;">
                    <input type="text" id="trip-title" placeholder="–ö—É–¥–∞ –µ–¥–µ–º? (–Ω–∞–ø—Ä. –†–∏–º)">
                </div>
                <div style="flex: 1; min-width: 140px;">
                    <input type="date" id="trip-start">
                </div>
                <div style="flex: 1; min-width: 140px;">
                    <input type="date" id="trip-end">
                </div>
                <div style="flex: 1; min-width: 120px;">
                    <input type="number" id="trip-budget" placeholder="–ë—é–¥–∂–µ—Ç ‚ÇΩ">
                </div>
            </div>
            <button onclick="createTrip()" style="margin-top: 10px;">‚ú® –°–æ–∑–¥–∞—Ç—å –ø–æ–µ–∑–¥–∫—É</button>
        </div>

        <div id="trips-list" class="trips-grid"></div>
    </div>

    <script src="script.js"></script>
    <script>
        async function loadMe() {
            const res = await fetchAPI('/me');
            if (!res.ok) return;
            const me = await res.json();
            if (me && me.is_admin) {
                document.getElementById('admin-btn').innerHTML = `
                    <button class="secondary" style="width:auto;" onclick="window.location.href='/admin.html'">–ê–¥–º–∏–Ω</button>
                `;
            }
        }

        async function loadMotd() {
            const res = await fetchAPI('/motd');
            if (!res.ok) return;
            const data = await res.json();
            if (data && data.message) {
                const el = document.getElementById('motd');
                el.style.display = 'block';
                el.innerHTML = `<h3 style="margin-bottom: 8px;">üì£ –°–æ–æ–±—â–µ–Ω–∏–µ</h3><div>${data.message}</div>`;
            }
        }

        // –õ–æ–≥–∏–∫–∞ —Ç–∞ –∂–µ, –º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ HTML –≤–Ω—É—Ç—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–∞
        async function loadTrips() {
            const res = await fetchAPI('/trips');
            const trips = await res.json();
            const container = document.getElementById('trips-list');
            
            if (trips.length === 0) {
                container.innerHTML = '<p style="grid-column: 1/-1; text-align: center;">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ–µ–∑–¥–æ–∫. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é!</p>';
                return;
            }

            container.innerHTML = trips.map(t => `
                <div class="trip-card">
                    <div>
                        <h3>${t.title}</h3>
                        <p class="badge">üìÖ ${t.start_date} ‚Äî ${t.end_date}</p>
                        <p style="font-size: 0.9rem">–ë—é–¥–∂–µ—Ç: <b>${t.budget} ‚ÇΩ</b></p>
                    </div>
                    <div class="flex" style="margin-top: 15px;">
                        <button onclick="window.location.href='/trip.html?id=${t.id}'">–û—Ç–∫—Ä—ã—Ç—å</button>
                        <button class="danger" style="width: auto;" onclick="deleteTrip(${t.id})">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        async function createTrip() {
            const title = document.getElementById('trip-title').value;
            const start_date = document.getElementById('trip-start').value;
            const end_date = document.getElementById('trip-end').value;
            const budget = document.getElementById('trip-budget').value;
            
            if(!title || !start_date) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è");

            await fetchAPI('/trips', 'POST', { title, start_date, end_date, budget });
            loadTrips();
            // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π
            document.getElementById('trip-title').value = '';
        }

        async function deleteTrip(id) {
            if(confirm('–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø–æ–µ–∑–¥–∫—É?')) {
                await fetchAPI(`/trips/${id}`, 'DELETE');
                loadTrips();
            }
        }
        loadMe();
        loadMotd();
        loadTrips();
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ü–ª–∞–Ω –ø–æ–µ–∑–¥–∫–∏</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <button class="secondary" style="width: auto; margin-bottom: 20px;" onclick="window.location.href='/dashboard.html'">‚Üê –ù–∞–∑–∞–¥</button>
        
        <div id="trip-header" class="card" style="border-left: 5px solid var(--primary);">
            </div>

        <div class="card">
            <h3>üìç –î–æ–±–∞–≤–∏—Ç—å –º–µ—Å—Ç–æ –∏–ª–∏ —Å–æ–±—ã—Ç–∏–µ</h3>
            <div class="flex" style="flex-wrap: wrap;">
                <input type="number" id="item-day" placeholder="–î–µ–Ω—å (1, 2...)" style="flex: 1; min-width: 80px;">
                <input type="time" id="item-time" style="flex: 1; min-width: 100px;">
                <input type="number" id="item-cost" placeholder="–¶–µ–Ω–∞ ‚ÇΩ" style="flex: 1; min-width: 100px;">
            </div>
            <input type="text" id="item-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä. –û–±–µ–¥ –≤ —Ü–µ–Ω—Ç—Ä–µ)">
            <input type="text" id="item-notes" placeholder="–ó–∞–º–µ—Ç–∫–∞ (–∞–¥—Ä–µ—Å, –Ω–æ–º–µ—Ä —Ä–µ–π—Å–∞)">
            <button onclick="addItem()">–î–æ–±–∞–≤–∏—Ç—å –≤ –ø–ª–∞–Ω</button>
        </div>

        <div id="items-list" class="timeline"></div>
    </div>

    <script src="script.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const tripId = urlParams.get('id');
        let tripData = null;

        async function loadTripDetails() {
            const res = await fetchAPI(`/trips/${tripId}`);
            if (!res.ok) window.location.href = '/dashboard.html';
            tripData = await res.json();
            
            const spent = tripData.items.reduce((sum, item) => sum + (item.cost || 0), 0);
            
            document.getElementById('trip-header').innerHTML = `
                <div class="flex" style="align-items: flex-start;">
                    <div>
                        <h1>${tripData.title}</h1>
                        <p class="badge">üìÖ ${tripData.start_date} ‚Äî ${tripData.end_date}</p>
                    </div>
                    <div style="text-align: right;">
                        <p>–ë—é–¥–∂–µ—Ç: <b>${tripData.budget} ‚ÇΩ</b></p>
                        <p style="color: ${spent > tripData.budget ? 'var(--danger)' : 'var(--success)'}">
                            –ü–æ—Ç—Ä–∞—á–µ–Ω–æ: <b>${spent} ‚ÇΩ</b>
                        </p>
                    </div>
                </div>
                <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">
                <a href="/api/trips/${tripId}/pdf?token=${getToken()}" target="_blank" style="text-decoration: none;">
                    <button class="secondary">üìÑ –°–∫–∞—á–∞—Ç—å PDF –ø–ª–∞–Ω</button>
                </a>
            `;

            const list = document.getElementById('items-list');
            list.innerHTML = '';

            if (tripData.items.length === 0) {
                list.innerHTML = '<p style="padding-left: 20px;">–ú–∞—Ä—à—Ä—É—Ç –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ!</p>';
                return;
            }

            // –†–µ–Ω–¥–µ—Ä —Å –Ω–æ–≤—ã–º –¥–∏–∑–∞–π–Ω–æ–º (Timeline)
            let currentDay = null;
            
            tripData.items.forEach(item => {
                // –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –¥–Ω–µ–π
                if (item.day_number !== currentDay) {
                    currentDay = item.day_number;
                    list.innerHTML += `<h3 style="margin-left: 10px; margin-top: 30px; color: var(--primary);">–î–µ–Ω—å ${currentDay}</h3>`;
                }

                list.innerHTML += `
                    <div class="card timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="flex" style="align-items: flex-start;">
                            <div style="flex-grow: 1;">
                                <div style="font-weight: 600; font-size: 1.1rem; color: #333;">
                                    ${item.time} ‚Äî ${item.title}
                                </div>
                                ${item.notes ? `<div style="color: #666; font-size: 0.95rem; margin-top: 5px;">${item.notes}</div>` : ''}
                            </div>
                            <div style="text-align: right; min-width: 80px;">
                                <div style="font-weight: bold;">${item.cost || 0} ‚ÇΩ</div>
                                <button class="danger" style="width: auto; padding: 5px 10px; margin-top: 5px; font-size: 0.8rem;" onclick="deleteItem(${item.id})">–£–¥–∞–ª–∏—Ç—å</button>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        async function addItem() {
            const body = {
                day_number: document.getElementById('item-day').value,
                time: document.getElementById('item-time').value,
                cost: document.getElementById('item-cost').value,
                title: document.getElementById('item-title').value,
                notes: document.getElementById('item-notes').value
            };
            if(!body.day_number || !body.title) return alert("–£–∫–∞–∂–∏—Ç–µ –¥–µ–Ω—å –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ");
            
            await fetchAPI(`/trips/${tripId}/items`, 'POST', body);
            loadTripDetails();
            
            // –û—á–∏—Å—Ç–∫–∞
            document.getElementById('item-title').value = '';
            document.getElementById('item-notes').value = '';
            document.getElementById('item-cost').value = '';
        }

        async function deleteItem(itemId) {
            if(confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—É–Ω–∫—Ç?')) {
                await fetchAPI(`/items/${itemId}`, 'DELETE');
                loadTripDetails();
            }
        }

        loadTripDetails();
    </script>
</body>
</html>
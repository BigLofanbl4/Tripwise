<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ü–ª–∞–Ω –ø–æ–µ–∑–¥–∫–∏</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <button class="secondary" style="width: auto; margin-bottom: 20px;" onclick="window.location.href='/dashboard.html'">‚Üê –ù–∞–∑–∞–¥</button>
        
        <div id="trip-header" class="card" style="border-left: 5px solid var(--primary);">
            </div>

        <div id="weather-card" class="card" style="display:none; border-left: 5px solid var(--primary);"></div>

        <div class="card" style="padding: 0; overflow: hidden;">
            <div class="flex" style="gap: 0;">
                <button id="tab-route" class="secondary" style="border-radius: 0; width: 50%;" onclick="showTab('route')">–ú–∞—Ä—à—Ä—É—Ç</button>
                <button id="tab-packing" class="secondary" style="border-radius: 0; width: 50%;" onclick="showTab('packing')">–ß—Ç–æ –≤–∑—è—Ç—å —Å —Å–æ–±–æ–π</button>
            </div>
        </div>

        <div id="tab-content-route" class="tab-content">
            <div id="stats-card" class="card" style="display:none; border-left: 5px solid var(--primary);"></div>

        <div class="card">
            <h3>üìç –î–æ–±–∞–≤–∏—Ç—å –º–µ—Å—Ç–æ –∏–ª–∏ —Å–æ–±—ã—Ç–∏–µ</h3>
            <div class="flex" style="flex-wrap: wrap;">
                <input type="number" id="item-day" placeholder="–î–µ–Ω—å (1, 2...)" style="flex: 1; min-width: 80px;">
                <input type="time" id="item-time" style="flex: 1; min-width: 100px;">
                <input type="number" id="item-cost" placeholder="–¶–µ–Ω–∞ ‚ÇΩ" style="flex: 1; min-width: 100px;">
            </div>
            <select id="item-category" style="width: 100%; margin-top: 10px;">
                <option value="–û—Ç–µ–ª—å">–û—Ç–µ–ª—å</option>
                <option value="–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option>
                <option value="–ï–¥–∞">–ï–¥–∞</option>
                <option value="–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è">–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</option>
                <option value="–î—Ä—É–≥–æ–µ" selected>–î—Ä—É–≥–æ–µ</option>
            </select>
            <input type="text" id="item-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä. –û–±–µ–¥ –≤ —Ü–µ–Ω—Ç—Ä–µ)">
            <input type="text" id="item-notes" placeholder="–ó–∞–º–µ—Ç–∫–∞ (–∞–¥—Ä–µ—Å, –Ω–æ–º–µ—Ä —Ä–µ–π—Å–∞)">
            <button onclick="addItem()">–î–æ–±–∞–≤–∏—Ç—å –≤ –ø–ª–∞–Ω</button>
        </div>

        <div id="items-list" class="timeline"></div>
        </div>

        <div id="tab-content-packing" class="tab-content" style="display:none;">
            <div class="card">
                <h3>üß≥ –ß—Ç–æ –≤–∑—è—Ç—å —Å —Å–æ–±–æ–π</h3>
                <div class="flex" style="align-items: center; flex-wrap: wrap;">
                    <input stype="text" id="packing-title" placeholder="–ù–∞–ø—Ä. –ü–∞—Å–ø–æ—Ä—Ç" style="flex: 1; min-width: 220px; margin-bottom: 0;">
                    <button style="width:auto;" onclick="addPackingItem()">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
            </div>
            <div id="packing-list" class="card"></div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const tripId = urlParams.get('id');
        let tripData = null;

        function showTab(tab) {
            const route = document.getElementById('tab-content-route');
            const packing = document.getElementById('tab-content-packing');

            if (tab === 'packing') {
                route.style.display = 'none';
                packing.style.display = 'block';
                loadPacking();
            } else {
                packing.style.display = 'none';
                route.style.display = 'block';
                loadStats();
            }
        }

        async function loadWeather() {
            const card = document.getElementById('weather-card');
            const res = await fetchAPI(`/trips/${tripId}/weather`);
            if (!res.ok) {
                let msg = '–ü–æ–≥–æ–¥–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞';
                try {
                    const err = await res.json();
                    if (err && err.error) msg = `–ü–æ–≥–æ–¥–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: ${err.error}`;
                } catch(e) {}
                card.style.display = 'block';
                card.innerHTML = `<div style="color: var(--text-secondary);">${msg}</div>`;
                return;
            }
            const data = await res.json();
            if (!data || !data.current) {
                card.style.display = 'none';
                return;
            }

            const icon = data.current.icon ? `https://openweathermap.org/img/wn/${data.current.icon}@2x.png` : '';
            const forecast = Array.isArray(data.forecast_days) ? data.forecast_days : [];
            const forecastHtml = forecast.length
                ? `<div style="margin-top: 10px;">
                        <div style="font-weight: 600; margin-bottom: 6px;">–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –¥–∞—Ç—ã –ø–æ–µ–∑–¥–∫–∏</div>
                        ${forecast.map(d => {
                            const ic = d.icon ? `https://openweathermap.org/img/wn/${d.icon}.png` : '';
                            const t = (d.temp_min !== null && d.temp_max !== null) ? `${d.temp_min}‚Ä¶${d.temp_max}¬∞C` : '';
                            return `<div class="flex" style="justify-content: space-between; gap: 10px; padding: 6px 0; border-bottom: 1px solid #eee;">
                                        <div>${d.date}</div>
                                        <div class="flex" style="width:auto; gap: 8px; align-items:center;">
                                            ${ic ? `<img src="${ic}" alt="" width="28" height="28" style="display:block;"/>` : ''}
                                            <div style="text-align:right;">
                                                <div style="font-weight:600;">${t}</div>
                                                <div style="color: var(--text-secondary); font-size: 0.9rem;">${d.description || ''}</div>
                                            </div>
                                        </div>
                                    </div>`;
                        }).join('')}
                   </div>`
                : '';

            card.style.display = 'block';
            card.innerHTML = `
                <div class="flex" style="align-items:center; justify-content: space-between; gap: 12px;">
                    <div>
                        <h3 style="margin:0;">üå§Ô∏è –ü–æ–≥–æ–¥–∞</h3>
                        <div style="color: var(--text-secondary);">${data.city || ''}</div>
                    </div>
                    <div class="flex" style="width:auto; gap: 10px; align-items:center;">
                        ${icon ? `<img src="${icon}" alt="" width="48" height="48" style="display:block;"/>` : ''}
                        <div style="text-align:right;">
                            <div style="font-size: 1.5rem; font-weight: 700;">${data.current.temp !== null ? data.current.temp : ''}¬∞C</div>
                            <div style="color: var(--text-secondary);">${data.current.description || ''}</div>
                        </div>
                    </div>
                </div>
                ${forecastHtml}
            `;
        }

        async function loadStats() {
            const statsCard = document.getElementById('stats-card');
            const res = await fetchAPI(`/trips/${tripId}/stats`);
            if (!res.ok) {
                statsCard.style.display = 'none';
                return;
            }
            const stats = await res.json();
            const food = (stats.categories || []).find(c => c.category === '–ï–¥–∞');
            if (!food || !stats.budget) {
                statsCard.style.display = 'none';
                return;
            }
            statsCard.style.display = 'block';
            statsCard.innerHTML = `
                <div class="flex" style="align-items:flex-start;">
                    <div>
                        <h3 style="margin:0;">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h3>
                        <p style="margin:5px 0 0 0;">–í—ã –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏ <b>${food.percentage}%</b> –±—é–¥–∂–µ—Ç–∞ –Ω–∞ <b>–µ–¥—É</b>.</p>
                    </div>
                    <div style="text-align:right;">
                        <div>–ü–æ—Ç—Ä–∞—á–µ–Ω–æ: <b>${stats.total_spent} ‚ÇΩ</b></div>
                        <div>–û—Å—Ç–∞–ª–æ—Å—å: <b>${stats.remaining} ‚ÇΩ</b></div>
                    </div>
                </div>
            `;
        }

        async function loadPacking() {
            const container = document.getElementById('packing-list');
            const res = await fetchAPI(`/trips/${tripId}/packing`);
            if (!res.ok) {
                container.innerHTML = '<p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫.</p>';
                return;
            }
            const items = await res.json();
            if (!items.length) {
                container.innerHTML = '<p>–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –≤–µ—â—å!</p>';
                return;
            }
            container.innerHTML = items.map(i => `
                <div class="packing-row">
                    <label class="packing-label">
                        <input class="packing-checkbox" type="checkbox" ${i.is_done ? 'checked' : ''} onchange="togglePacking(${i.id}, this.checked)">
                        <span class="packing-title ${i.is_done ? 'is-done' : ''}">${i.title}</span>
                    </label>
                    <button class="danger packing-delete" onclick="deletePacking(${i.id})">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            `).join('');
        }

        async function addPackingItem() {
            const titleEl = document.getElementById('packing-title');
            const title = titleEl.value.trim();
            if (!title) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');
            const res = await fetchAPI(`/trips/${tripId}/packing`, 'POST', { title });
            if (!res.ok) return alert('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å');
            titleEl.value = '';
            loadPacking();
        }

        async function togglePacking(id, isDone) {
            const res = await fetchAPI(`/packing/${id}`, 'PUT', { is_done: isDone });
            if (!res.ok) return alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å');
            loadPacking();
        }

        async function deletePacking(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –≤–µ—â—å?')) return;
            const res = await fetchAPI(`/packing/${id}`, 'DELETE');
            if (!res.ok) return alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å');
            loadPacking();
        }

        async function loadTripDetails() {
            const res = await fetchAPI(`/trips/${tripId}`);
            if (!res.ok) window.location.href = '/dashboard.html';
            tripData = await res.json();

            const spent = tripData.items.reduce((sum, item) => sum + (item.cost || 0), 0);

            document.getElementById('trip-header').innerHTML = `
                <div class="flex" style="align-items: flex-start;">
                    <div>
                        <h1>${tripData.title}</h1>
                        <p class="badge">üìÖ ${tripData.start_date} ‚Äî ${tripData.end_date}</p>
                    </div>
                    <div style="text-align: right;">
                        <p>–ë—é–¥–∂–µ—Ç: <b>${tripData.budget} ‚ÇΩ</b></p>
                        <p style="color: ${spent > tripData.budget ? 'var(--danger)' : 'var(--success)'}">
                            –ü–æ—Ç—Ä–∞—á–µ–Ω–æ: <b>${spent} ‚ÇΩ</b>
                        </p>
                    </div>
                </div>
                <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">
                <a href="/api/trips/${tripId}/pdf?token=${getToken()}" target="_blank" style="text-decoration: none;">
                    <button class="secondary">üìÑ –°–∫–∞—á–∞—Ç—å PDF –ø–ª–∞–Ω</button>
                </a>
            `;

            loadWeather();

            const list = document.getElementById('items-list');
            list.innerHTML = '';

            if (tripData.items.length === 0) {
                list.innerHTML = '<p style="padding-left: 20px;">–ú–∞—Ä—à—Ä—É—Ç –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ!</p>';
                return;
            }

            let currentDay = null;
            tripData.items.forEach(item => {
                if (item.day_number !== currentDay) {
                    currentDay = item.day_number;
                    list.innerHTML += `<h3 style="margin-left: 10px; margin-top: 30px; color: var(--primary);">–î–µ–Ω—å ${currentDay}</h3>`;
                }

                const cat = item.category ? `<span class="badge" style="margin-left:8px; font-size:0.75rem;">${item.category}</span>` : '';

                list.innerHTML += `
                    <div class="card timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="flex" style="align-items: flex-start;">
                            <div style="flex-grow: 1;">
                                <div style="font-weight: 600; font-size: 1.1rem; color: #333;">
                                    ${item.time} ‚Äî ${item.title} ${cat}
                                </div>
                                ${item.notes ? `<div style="color: #666; font-size: 0.95rem; margin-top: 5px;">${item.notes}</div>` : ''}
                            </div>
                            <div style="text-align: right; min-width: 80px;">
                                <div style="font-weight: bold;">${item.cost || 0} ‚ÇΩ</div>
                                <button class="danger" style="width: auto; padding: 5px 10px; margin-top: 5px; font-size: 0.8rem;" onclick="deleteItem(${item.id})">–£–¥–∞–ª–∏—Ç—å</button>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        async function addItem() {
            const body = {
                day_number: document.getElementById('item-day').value,
                time: document.getElementById('item-time').value,
                cost: document.getElementById('item-cost').value,
                title: document.getElementById('item-title').value,
                notes: document.getElementById('item-notes').value,
                category: document.getElementById('item-category').value
            };
            if (!body.day_number || !body.title) return alert('–£–∫–∞–∂–∏—Ç–µ –¥–µ–Ω—å –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ');

            await fetchAPI(`/trips/${tripId}/items`, 'POST', body);
            loadTripDetails();

            document.getElementById('item-title').value = '';
            document.getElementById('item-notes').value = '';
            document.getElementById('item-cost').value = '';
        }

        async function deleteItem(itemId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—É–Ω–∫—Ç?')) return;
            await fetchAPI(`/items/${itemId}`, 'DELETE');
            loadTripDetails();
        }

        loadTripDetails();
        showTab('route');
    </script>
</body>
</html>